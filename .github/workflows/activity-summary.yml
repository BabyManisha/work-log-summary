name: Update Work Summary

on:
  schedule:
    - cron: "0 0 * * *" # Runs every day at 12:00 AM UTC
  workflow_dispatch: # Allows manual triggering of the workflow

jobs:
  update-summary:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Fetch and Format Activity Data
        env:
          PAT: ${{ secrets.PAT }}
        run: |
          # Create or read the last updated timestamp
          LAST_UPDATED_FILE=".last-updated.txt"
          if [ -f $LAST_UPDATED_FILE ]; then
            LAST_UPDATED=$(cat $LAST_UPDATED_FILE)
          else
            LAST_UPDATED="1970-01-01T00:00:00Z"
          fi

          # Create a temporary file for new activities
          ACTIVITY_FILE="new-activity.md"
          echo "### Work Summary - $(date -u +"%Y-%m-%d %H:%M:%S UTC")" > $ACTIVITY_FILE
          echo "" >> $ACTIVITY_FILE

          # Fetch and Print Data - Uncomment below lines for debugging purposes
          # curl -s -H "Authorization: token $PAT" "https://api.github.com/users/${{ github.actor }}/events" > api-response.json
          # cat api-response.json

          # Fetch events and filter by timestamp
          curl -s -H "Authorization: token $PAT" "https://api.github.com/users/${{ github.actor }}/events" | \
          jq -r --arg LAST_UPDATED "$LAST_UPDATED" '
            .[] |
            select(.created_at > $LAST_UPDATED) | # Only include events after the last update
            if .type == "PushEvent" then
              .repo.name as $repo_name |
              .payload.commits[] |
              select(.distinct == true) |
              "- **Commit:** \(.message // "No message provided") in \($repo_name) [â†—](https://github.com/\($repo_name)/commit/\(.sha))"
            elif .type == "PullRequestEvent" then
              "- **Pull Request:** \(.payload.pull_request.title // "No title provided") in \(.repo.name // "Unknown repository") [ðŸ”—](\(.payload.pull_request.html_url))"
            end
          ' >> $ACTIVITY_FILE

          # Check if there are new activities
          if [ $(wc -l < $ACTIVITY_FILE) -eq 2 ]; then
            echo "No new activities to log. Exiting."
            exit 0
          fi

          # Update the last updated timestamp
          date -u +"%Y-%m-%dT%H:%M:%SZ" > $LAST_UPDATED_FILE

      - name: Append New Activities to Work Log
        run: |
          cat new-activity.md >> work-summary.md

      - name: Commit and Push Changes
        run: |
          git config --global user.name "Baby Manisha Sunkara"
          git config --global user.email "babymaneesha@gmail.com"
          git add work-summary.md
          git commit -m "Update work summary: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" || echo "No changes to commit"
          git push
